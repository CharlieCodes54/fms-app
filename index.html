<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FMS Assessment</title>

  <!-- Styles -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    :root {
      --bg: #020817;
      --bg-soft: #020817;
      --card-bg: #020817;
      --card-elevated: #020817;
      --border-subtle: #111827;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --text-muted: #6b7280;
      --danger: #f97316;
      --radius: 12px;
      --shadow-soft: 0 14px 45px rgba(15,23,42,0.45);
      --input-bg: #020817;
      --input-border: #111827;
    }

    body {
      background: radial-gradient(circle at top left, #111827 0, #020817 40%, #020817 100%);
      color: var(--text-main);
      padding: 24px;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto 40px auto;
    }

    header {
      margin-bottom: 18px;
    }

    header h1 {
      font-size: 26px;
      font-weight: 600;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
      color: #f9fafb;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.06) 0, #020817 40%);
      padding: 16px 18px 14px 18px;
      margin-bottom: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
    }

    .card h2 {
      font-size: 17px;
      margin-bottom: 4px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .movement-notes {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    label {
      font-size: 11px;
      display: block;
      margin-bottom: 3px;
      color: var(--text-soft);
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      font-size: 12px;
      margin-bottom: 8px;
      background: var(--input-bg);
      color: var(--text-main);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.25);
    }

    textarea {
      resize: vertical;
    }

    .grid-2,
    .grid-3,
    .grid-4 {
      display: grid;
      gap: 10px;
      margin-bottom: 6px;
    }

    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }

    @media (max-width: 800px) {
      .grid-2,
      .grid-3,
      .grid-4 {
        grid-template-columns: 1fr;
      }
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 16px;
      margin-bottom: 6px;
      font-size: 10px;
    }

    .checkbox-group span {
      flex-basis: 100%;
      font-weight: 500;
      color: var(--text-soft);
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 0;
      color: var(--text-soft);
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      margin-bottom: 6px;
    }

    .summary-row div {
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .summary-label {
      color: var(--text-muted);
    }

    .summary-value {
      color: var(--accent);
      font-weight: 500;
    }

    .summary-pill-danger {
      color: var(--danger);
      font-weight: 600;
    }

    .actions {
      margin-top: 6px;
      display: flex;
      gap: 8px;
    }

    button {
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      cursor: pointer;
      background: var(--accent);
      color: #020817;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
    }

    button#generatePdfBtn {
      background: #111827;
      color: var(--text-main);
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(15,23,42,0.5);
    }

    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .ai-summary {
      margin-top: 8px;
      padding: 8px;
      background: rgba(9,9,11,0.98);
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
    }

    .ai-summary h3 {
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--accent);
      font-weight: 500;
    }

    .ai-text {
      font-size: 10px;
      line-height: 1.5;
      color: var(--text-soft);
    }

    .ai-text strong {
      color: #e5e7eb;
      font-weight: 600;
    }

    .ai-section-title {
      display: block;
      margin-top: 4px;
      margin-bottom: 2px;
      font-size: 10px;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .ai-client-summary {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      background: var(--accent-soft);
      color: #bae6fd;
      font-size: 10px;
    }

    .hidden {
      display: none;
    }
  </style>

  <!-- pdfmake (for PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body>
  <div class="app-container">
    <header>
      <h1>FMS Assessment</h1>
      <p class="subtitle">Standardized capture · Auto-scoring · AI-assisted, client-ready summary</p>
    </header>

    <!-- Client Info -->
    <section class="card">
      <h2>Client Information</h2>
      <div class="grid-2">
        <div>
          <label for="clientName">Client Name</label>
          <input id="clientName" type="text" placeholder="Full name">
        </div>
        <div>
          <label for="assessmentDate">Assessment Date</label>
          <input id="assessmentDate" type="date">
        </div>
        <div>
          <label for="sex">Sex</label>
          <select id="sex">
            <option value="">Select</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
            <option>Prefer not to say</option>
          </select>
        </div>
        <div>
          <label for="sport">Sport / Occupation</label>
          <input id="sport" type="text" placeholder="e.g., office worker, recreational runner">
        </div>
      </div>
      <label for="history">Relevant History / Precautions</label>
      <textarea id="history" rows="2" placeholder="Previous injuries, pain, medical clearance notes (no diagnoses)."></textarea>
    </section>

    <!-- FMS Form -->
    <form id="fms-form">
      <!-- Deep Squat -->
      <section class="card test-section" data-test="deepSquat">
        <h2>1. Deep Squat</h2>
        <div class="movement-notes">
          Setup: Feet shoulder-width, dowel overhead, hands wider than shoulders.  
          Execution: Full squat with heels down, knees tracking, dowel over feet, control through entire range.
        </div>
        <div class="grid-2">
          <div>
            <label>Score</label>
            <select id="deepSquat_score">
              <option value="">Select</option>
              <option value="3">3 - Full pattern, no faults</option>
              <option value="2">2 - Completes with minor compensation</option>
              <option value="1">1 - Unable to complete pattern</option>
              <option value="0">0 - Pain with movement</option>
            </select>
          </div>
        </div>
        <div class="checkbox-group">
          <span>Common Deviations</span>
          <label><input type="checkbox" name="deepSquat_dev" value="Heels lift">Heels lift</label>
          <label><input type="checkbox" name="deepSquat_dev" value="Knees valgus">Knees valgus</label>
          <label><input type="checkbox" name="deepSquat_dev" value="Knees varus">Knees varus</label>
          <label><input type="checkbox" name="deepSquat_dev" value="Lumbar flexion">Lumbar flexion</label>
          <label><input type="checkbox" name="deepSquat_dev" value="Lumbar hyperextension">Lumbar hyperextension</label>
          <label><input type="checkbox" name="deepSquat_dev" value="Excess forward lean">Excess forward lean</label>
          <label><input type="checkbox" name="deepSquat_dev" value="Bar not overhead / poor thoracic extension">Bar not overhead / poor thoracic extension</label>
          <label><input type="checkbox" name="deepSquat_dev" value="Asymmetrical weight shift">Asymmetrical weight shift</label>
        </div>
        <label>Notes</label>
        <textarea id="deepSquat_notes" rows="2"></textarea>
      </section>

      <!-- Hurdle Step -->
      <section class="card test-section" data-test="hurdleStep">
        <h2>2. Hurdle Step</h2>
        <div class="movement-notes">
          Setup: Hurdle at tibial tuberosity height, dowel across shoulders or behind neck.  
          Execution: Step over without touching string, pelvis level, trunk stable, stance foot stable.
        </div>
        <div class="grid-3">
          <div>
            <label>Left Score</label>
            <select id="hurdle_left_score">
              <option value="">Select</option>
              <option value="3">3 - Clean pattern</option>
              <option value="2">2 - Completes with compensation</option>
              <option value="1">1 - Cannot clear without loss of form</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Right Score</label>
            <select id="hurdle_right_score">
              <option value="">Select</option>
              <option value="3">3 - Clean pattern</option>
              <option value="2">2 - Completes with compensation</option>
              <option value="1">1 - Cannot clear without loss of form</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Final (auto)</label>
            <input id="hurdle_final" type="number" readonly>
          </div>
        </div>
        <div class="checkbox-group">
          <span>Common Deviations</span>
          <label><input type="checkbox" name="hurdle_dev" value="Loss of balance">Loss of balance</label>
          <label><input type="checkbox" name="hurdle_dev" value="Pelvic drop or hike">Pelvic drop/hike</label>
          <label><input type="checkbox" name="hurdle_dev" value="Hip external rotation / toe-out">Hip ER / toe-out</label>
          <label><input type="checkbox" name="hurdle_dev" value="Knee valgus/varus">Knee valgus/varus</label>
          <label><input type="checkbox" name="hurdle_dev" value="Trunk lateral flexion/rotation">Trunk deviation</label>
          <label><input type="checkbox" name="hurdle_dev" value="Foot contacts hurdle / poor clearance">Poor clearance</label>
        </div>
        <label>Notes</label>
        <textarea id="hurdle_notes" rows="2"></textarea>
      </section>

      <!-- In-Line Lunge -->
      <section class="card test-section" data-test="inlineLunge">
        <h2>3. In-Line Lunge</h2>
        <div class="movement-notes">
          Setup: Heel-to-toe stance on straight line, dowel along spine (head, T-spine, sacrum).  
          Execution: Drop into lunge with control, trunk tall, front knee tracking over foot, dowel maintains contact.
        </div>
        <div class="grid-3">
          <div>
            <label>Left Score (left leg forward)</label>
            <select id="lunge_left_score">
              <option value="">Select</option>
              <option value="3">3 - Clean pattern</option>
              <option value="2">2 - Compensation present</option>
              <option value="1">1 - Loss of balance / poor alignment</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Right Score (right leg forward)</label>
            <select id="lunge_right_score">
              <option value="">Select</option>
              <option value="3">3 - Clean pattern</option>
              <option value="2">2 - Compensation present</option>
              <option value="1">1 - Loss of balance / poor alignment</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Final (auto)</label>
            <input id="lunge_final" type="number" readonly>
          </div>
        </div>
        <div class="checkbox-group">
          <span>Common Deviations</span>
          <label><input type="checkbox" name="lunge_dev" value="Loss of balance">Loss of balance</label>
          <label><input type="checkbox" name="lunge_dev" value="Trunk lean/rotation">Trunk lean/rotation</label>
          <label><input type="checkbox" name="lunge_dev" value="Knee not tracking over foot">Knee tracking fault</label>
          <label><input type="checkbox" name="lunge_dev" value="Rear heel lift">Rear heel lift</label>
          <label><input type="checkbox" name="lunge_dev" value="Limited depth">Limited depth</label>
        </div>
        <label>Notes</label>
        <textarea id="lunge_notes" rows="2"></textarea>
      </section>

      <!-- Shoulder Mobility -->
      <section class="card test-section" data-test="shoulderMobility">
        <h2>4. Shoulder Mobility</h2>
        <div class="movement-notes">
          Setup: Fists made, one hand overhead and one behind back.  
          Execution: Reach toward each other without warm-up; measure distance; compare sides; add clearing test.
        </div>
        <div class="grid-4">
          <div>
            <label>Left Score</label>
            <select id="shoulder_left_score">
              <option value="">Select</option>
              <option value="3">3 - Fists within one hand length</option>
              <option value="2">2 - Within 1.5 hand lengths</option>
              <option value="1">1 - More than 1.5 hand lengths</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Right Score</label>
            <select id="shoulder_right_score">
              <option value="">Select</option>
              <option value="3">3 - Fists within one hand length</option>
              <option value="2">2 - Within 1.5 hand lengths</option>
              <option value="1">1 - More than 1.5 hand lengths</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Clearing Pain?</label>
            <select id="shoulder_clearing">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div>
            <label>Final (auto)</label>
            <input id="shoulder_final" type="number" readonly>
          </div>
        </div>
        <div class="checkbox-group">
          <span>Common Deviations</span>
          <label><input type="checkbox" name="shoulder_dev" value="Excessive distance between fists">Excessive distance</label>
          <label><input type="checkbox" name="shoulder_dev" value="Asymmetry left/right">Asymmetry</label>
          <label><input type="checkbox" name="shoulder_dev" value="Scapular winging">Scapular winging</label>
          <label><input type="checkbox" name="shoulder_dev" value="Thoracic flexion/extension fault">Thoracic fault</label>
        </div>
        <label>Notes</label>
        <textarea id="shoulder_notes" rows="2"></textarea>
      </section>

      <!-- Active Straight-Leg Raise -->
      <section class="card test-section" data-test="activeSLR">
        <h2>5. Active Straight-Leg Raise</h2>
        <div class="movement-notes">
          Setup: Supine, arms at sides, ankles in neutral.  
          Execution: Lift one leg with knee straight, opposite leg stays down; note where malleolus passes in relation to markers.
        </div>
        <div class="grid-3">
          <div>
            <label>Left Score</label>
            <select id="aslr_left_score">
              <option value="">Select</option>
              <option value="3">3 - Ankle above mid-thigh</option>
              <option value="2">2 - Ankle between mid-thigh and knee</option>
              <option value="1">1 - Ankle below knee line</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Right Score</label>
            <select id="aslr_right_score">
              <option value="">Select</option>
              <option value="3">3 - Ankle above mid-thigh</option>
              <option value="2">2 - Ankle between mid-thigh and knee</option>
              <option value="1">1 - Ankle below knee line</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Final (auto)</label>
            <input id="aslr_final" type="number" readonly>
          </div>
        </div>
        <div class="checkbox-group">
          <span>Common Deviations</span>
          <label><input type="checkbox" name="aslr_dev" value="Limited hamstring/hip flexion ROM">Limited ROM</label>
          <label><input type="checkbox" name="aslr_dev" value="Contralateral leg lifts">Contralateral leg lifts</label>
          <label><input type="checkbox" name="aslr_dev" value="Pelvic rotation / lumbar flexion">Pelvic/lumbar compensation</label>
        </div>
        <label>Notes</label>
        <textarea id="aslr_notes" rows="2"></textarea>
      </section>

      <!-- Trunk Stability Push-Up -->
      <section class="card test-section" data-test="trunkStabilityPU">
        <h2>6. Trunk Stability Push-Up</h2>
        <div class="movement-notes">
          Setup: Prone, hands at standardized position based on sex, feet together.  
          Execution: One rep push-up keeping body as a rigid plank, no sag or pike.
        </div>
        <div class="grid-3">
          <div>
            <label>Score</label>
            <select id="tspu_score">
              <option value="">Select</option>
              <option value="3">3 - Clean plank, no compensation</option>
              <option value="2">2 - Performs with adjusted hand position</option>
              <option value="1">1 - Unable to perform correctly</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Clearing Pain?</label>
            <select id="tspu_clearing">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>
        <div class="checkbox-group">
          <span>Common Deviations</span>
          <label><input type="checkbox" name="tspu_dev" value="Loss of neutral spine">Loss of neutral spine</label>
          <label><input type="checkbox" name="tspu_dev" value="Sagging hips">Sagging hips</label>
          <label><input type="checkbox" name="tspu_dev" value="Piking hips">Piking hips</label>
          <label><input type="checkbox" name="tspu_dev" value="Asymmetrical press">Asymmetrical press</label>
        </div>
        <label>Notes</label>
        <textarea id="tspu_notes" rows="2"></textarea>
      </section>

      <!-- Rotary Stability -->
      <section class="card test-section" data-test="rotaryStability">
        <h2>7. Rotary Stability</h2>
        <div class="movement-notes">
          Setup: Quadruped, hands under shoulders, knees under hips.  
          Execution: Same-side arm and leg reach, then elbow-to-knee, then extend; repeat opposite; note stability and control.
        </div>
        <div class="grid-4">
          <div>
            <label>Left Score</label>
            <select id="rotary_left_score">
              <option value="">Select</option>
              <option value="3">3 - Clean same-side pattern</option>
              <option value="2">2 - Clean opposite-side pattern</option>
              <option value="1">1 - Unable without loss of control</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Right Score</label>
            <select id="rotary_right_score">
              <option value="">Select</option>
              <option value="3">3 - Clean same-side pattern</option>
              <option value="2">2 - Clean opposite-side pattern</option>
              <option value="1">1 - Unable without loss of control</option>
              <option value="0">0 - Pain</option>
            </select>
          </div>
          <div>
            <label>Clearing Pain?</label>
            <select id="rotary_clearing">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div>
            <label>Final (auto)</label>
            <input id="rotary_final" type="number" readonly>
          </div>
        </div>
        <div class="checkbox-group">
          <span>Common Deviations</span>
          <label><input type="checkbox" name="rotary_dev" value="Loss of quadruped position">Loss of position</label>
          <label><input type="checkbox" name="rotary_dev" value="Trunk rotation / lateral shift">Trunk rotation/shift</label>
          <label><input type="checkbox" name="rotary_dev" value="Incomplete elbow-knee touch or extension">Incomplete pattern</label>
        </div>
        <label>Notes</label>
        <textarea id="rotary_notes" rows="2"></textarea>
      </section>
    </form>

    <!-- Summary and Actions -->
    <section class="card">
      <h2>Summary</h2>
      <div class="summary-row">
        <div>
          <span class="summary-label">Total FMS Score</span>
          <span class="summary-value" id="totalScore">- / 21</span>
        </div>
        <div>
          <span class="summary-label">Pain Present</span>
          <span class="summary-value" id="painPresent">No</span>
        </div>
        <div>
          <span class="summary-label">Asymmetries</span>
          <span class="summary-value" id="asymmetries">None</span>
        </div>
        <div>
          <span class="summary-label">Flags</span>
          <span class="summary-value" id="flags">None</span>
        </div>
      </div>
      <div id="aiSummaryContainer" class="ai-summary hidden">
        <h3>AI Interpretation</h3>
        <div id="aiSummaryText" class="ai-text"></div>
      </div>
      <div class="actions">
        <button id="generateAiBtn" type="button">Generate AI Summary</button>
        <button id="generatePdfBtn" type="button">Generate PDF Report</button>
      </div>
    </section>
  </div>

  <!-- App Logic -->
  <script>
    let latestAiInterpretation = null;

    document.addEventListener('DOMContentLoaded', () => {
      attachScoreListeners();
      updateSummary();
      document.getElementById('generateAiBtn').addEventListener('click', handleGenerateAi);
      document.getElementById('generatePdfBtn').addEventListener('click', handleGeneratePdf);
    });

    function toInt(val) {
      const n = parseInt(val, 10);
      return isNaN(n) ? null : n;
    }

    function attachScoreListeners() {
      const ids = [
        'deepSquat_score',
        'hurdle_left_score', 'hurdle_right_score',
        'lunge_left_score', 'lunge_right_score',
        'shoulder_left_score', 'shoulder_right_score',
        'aslr_left_score', 'aslr_right_score',
        'tspu_score',
        'rotary_left_score', 'rotary_right_score'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', updateSummary);
      });

      ['shoulder_clearing', 'tspu_clearing', 'rotary_clearing'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', updateSummary);
      });

      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => {});
      });
    }

    function buildFmsReport() {
      const client = {
        name: document.getElementById('clientName').value.trim(),
        sex: document.getElementById('sex').value,
        sport: document.getElementById('sport').value.trim(),
        assessmentDate: document.getElementById('assessmentDate').value,
        history: document.getElementById('history').value.trim()
      };

      const getChecks = (name) =>
        Array.from(document.querySelectorAll('input[name="' + name + '"]:checked'))
          .map(cb => cb.value);

      const deepSquatScore = toInt(document.getElementById('deepSquat_score').value);

      const hurdleLeft = toInt(document.getElementById('hurdle_left_score').value);
      const hurdleRight = toInt(document.getElementById('hurdle_right_score').value);
      const hurdleFinal = minNonNull(hurdleLeft, hurdleRight);

      const lungeLeft = toInt(document.getElementById('lunge_left_score').value);
      const lungeRight = toInt(document.getElementById('lunge_right_score').value);
      const lungeFinal = minNonNull(lungeLeft, lungeRight);

      const shoulderLeft = toInt(document.getElementById('shoulder_left_score').value);
      const shoulderRight = toInt(document.getElementById('shoulder_right_score').value);
      const shoulderClearingPain = document.getElementById('shoulder_clearing').value === 'yes';
      const shoulderBase = minNonNull(shoulderLeft, shoulderRight);
      const shoulderFinal = shoulderClearingPain ? 0 : shoulderBase;

      const aslrLeft = toInt(document.getElementById('aslr_left_score').value);
      const aslrRight = toInt(document.getElementById('aslr_right_score').value);
      const aslrFinal = minNonNull(aslrLeft, aslrRight);

      const tspuScoreRaw = toInt(document.getElementById('tspu_score').value);
      const tspuClearingPain = document.getElementById('tspu_clearing').value === 'yes';
      const tspuScore = tspuClearingPain && tspuScoreRaw !== null ? 0 : tspuScoreRaw;

      const rotaryLeft = toInt(document.getElementById('rotary_left_score').value);
      const rotaryRight = toInt(document.getElementById('rotary_right_score').value);
      const rotaryClearingPain = document.getElementById('rotary_clearing').value === 'yes';
      const rotaryBase = minNonNull(rotaryLeft, rotaryRight);
      const rotaryFinal = rotaryClearingPain ? 0 : rotaryBase;

      const tests = {
        deepSquat: {
          score: deepSquatScore,
          deviations: getChecks('deepSquat_dev'),
          notes: document.getElementById('deepSquat_notes').value.trim()
        },
        hurdleStep: {
          left: { score: hurdleLeft },
          right: { score: hurdleRight },
          deviations: getChecks('hurdle_dev'),
          notes: document.getElementById('hurdle_notes').value.trim(),
          finalScore: hurdleFinal
        },
        inlineLunge: {
          left: { score: lungeLeft },
          right: { score: lungeRight },
          deviations: getChecks('lunge_dev'),
          notes: document.getElementById('lunge_notes').value.trim(),
          finalScore: lungeFinal
        },
        shoulderMobility: {
          left: { score: shoulderLeft },
          right: { score: shoulderRight },
          deviations: getChecks('shoulder_dev'),
          notes: document.getElementById('shoulder_notes').value.trim(),
          clearingPain: shoulderClearingPain,
          finalScore: shoulderFinal
        },
        activeSLR: {
          left: { score: aslrLeft },
          right: { score: aslrRight },
          deviations: getChecks('aslr_dev'),
          notes: document.getElementById('aslr_notes').value.trim(),
          finalScore: aslrFinal
        },
        trunkStabilityPU: {
          score: tspuScore,
          deviations: getChecks('tspu_dev'),
          notes: document.getElementById('tspu_notes').value.trim(),
          clearingPain: tspuClearingPain
        },
        rotaryStability: {
          left: { score: rotaryLeft },
          right: { score: rotaryRight },
          deviations: getChecks('rotary_dev'),
          notes: document.getElementById('rotary_notes').value.trim(),
          clearingPain: rotaryClearingPain,
          finalScore: rotaryFinal
        }
      };

      const finalScores = [
        deepSquatScore,
        hurdleFinal,
        lungeFinal,
        shoulderFinal,
        aslrFinal,
        tspuScore,
        rotaryFinal
      ];

      const totalScore = finalScores.reduce((sum, v) => sum + (v ?? 0), 0);

      const painPresent =
        shoulderClearingPain ||
        tspuClearingPain ||
        rotaryClearingPain ||
        hasZero(finalScores);

      const asymmetries = {
        'Hurdle Step': isAsym(hurdleLeft, hurdleRight),
        'In-Line Lunge': isAsym(lungeLeft, lungeRight),
        'Shoulder Mobility': isAsym(shoulderLeft, shoulderRight),
        'Active SLR': isAsym(aslrLeft, aslrRight),
        'Rotary Stability': isAsym(rotaryLeft, rotaryRight)
      };

      const flags = [];
      if (painPresent) flags.push('Pain or score of 0 present');
      if (totalScore && totalScore < 14) flags.push('Total score < 14 (higher risk cluster)');
      Object.entries(asymmetries).forEach(([k, v]) => {
        if (v) flags.push('Asymmetry in ' + k);
      });

      return {
        client,
        tests,
        derived: {
          totalScore,
          painPresent,
          asymmetries,
          flags
        }
      };
    }

    function minNonNull(a, b) {
      if (a == null && b == null) return null;
      if (a == null) return b;
      if (b == null) return a;
      return Math.min(a, b);
    }

    function hasZero(arr) {
      return arr.some(v => v === 0);
    }

    function isAsym(a, b) {
      if (a == null || b == null) return false;
      return a !== b;
    }

    function updateSummary() {
      const report = buildFmsReport();
      const derived = report.derived;

      document.getElementById('hurdle_final').value =
        report.tests.hurdleStep.finalScore ?? '';
      document.getElementById('lunge_final').value =
        report.tests.inlineLunge.finalScore ?? '';
      document.getElementById('shoulder_final').value =
        report.tests.shoulderMobility.finalScore ?? '';
      document.getElementById('aslr_final').value =
        report.tests.activeSLR.finalScore ?? '';
      document.getElementById('rotary_final').value =
        report.tests.rotaryStability.finalScore ?? '';

      const scoreText = derived.totalScore
        ? derived.totalScore + ' / 21'
        : '- / 21';
      document.getElementById('totalScore').textContent = scoreText;

      document.getElementById('painPresent').textContent =
        derived.painPresent ? 'Yes (review / consider referral)' : 'No';

      const asymList = Object.entries(derived.asymmetries)
        .filter(([, v]) => v)
        .map(([k]) => k)
        .join(', ');
      document.getElementById('asymmetries').textContent =
        asymList || 'None';

      document.getElementById('flags').textContent =
        derived.flags && derived.flags.length
          ? derived.flags.join(' | ')
          : 'None';
    }

    async function handleGenerateAi() {
      const btn = document.getElementById('generateAiBtn');
      btn.disabled = true;
      const report = buildFmsReport();

      try {
        const res = await fetch('/api/fms-interpretation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(report)
        });

        if (!res.ok) throw new Error('API error');

        const data = await res.json();
        latestAiInterpretation = data;

        const aiContainer = document.getElementById('aiSummaryContainer');
        const aiText = document.getElementById('aiSummaryText');
        aiContainer.classList.remove('hidden');
        aiText.innerHTML = formatAiTextForDisplay(data);
      } catch (err) {
        alert('AI summary failed. Ensure /api/fms-interpretation is configured.');
      } finally {
        btn.disabled = false;
      }
    }

    // Trainer-optimized + client section formatting
    function formatAiTextForDisplay(data) {
      const {
        summary,
        movement_dysfunctions,
        priority_issues,
        training_recommendations,
        client_summary
      } = data || {};

      const lines = [];

      // Trainer overview
      if (summary) {
        lines.push('<span class="ai-section-title">Trainer Overview</span>');
        lines.push('<div>' + escapeHtml(summary) + '</div>');
      }

      // Key movement findings
      if (Array.isArray(movement_dysfunctions) && movement_dysfunctions.length) {
        lines.push('<span class="ai-section-title">Key Movement Findings</span>');
        movement_dysfunctions.forEach(md => {
          if (!md || !md.pattern) return;
          lines.push('<div><strong>' + escapeHtml(md.pattern) + '</strong></div>');
          if (Array.isArray(md.key_points)) {
            md.key_points.forEach(p => {
              lines.push('<div>- ' + escapeHtml(p) + '</div>');
            });
          } else if (Array.isArray(md.findings)) {
            md.findings.forEach(p => {
              lines.push('<div>- ' + escapeHtml(p) + '</div>');
            });
          }
          if (Array.isArray(md.implications) && md.implications.length) {
            lines.push('<div style="margin-left:8px; color:#9ca3af;">Implications:</div>');
            md.implications.forEach(im => {
              lines.push('<div style="margin-left:12px;">• ' + escapeHtml(im) + '</div>');
            });
          }
        });
      }

      // Priority issues
      if (Array.isArray(priority_issues) && priority_issues.length) {
        lines.push('<span class="ai-section-title">Priority Issues</span>');
        priority_issues.forEach(p => {
          lines.push('<div>- ' + escapeHtml(p) + '</div>');
        });
      }

      const tr = training_recommendations || {};

      // Contraindications
      if (Array.isArray(tr.contraindications) && tr.contraindications.length) {
        lines.push('<span class="ai-section-title">Programming Contraindications</span>');
        tr.contraindications.forEach(c => {
          lines.push('<div>- ' + escapeHtml(c) + '</div>');
        });
      }

      // Goals
      if (Array.isArray(tr.goals) && tr.goals.length) {
        lines.push('<span class="ai-section-title">Primary Goals</span>');
        tr.goals.forEach(g => {
          lines.push('<div>- ' + escapeHtml(g) + '</div>');
        });
      }

      // Implementation strategy
      if (Array.isArray(tr.implementation_strategy) && tr.implementation_strategy.length) {
        lines.push('<span class="ai-section-title">Implementation Strategy</span>');
        tr.implementation_strategy.forEach(s => {
          lines.push('<div>- ' + escapeHtml(s) + '</div>');
        });
      }

      // Phase 1 / Phase 2 (kept concise)
      if (Array.isArray(tr.phase_1_focus) && tr.phase_1_focus.length) {
        lines.push('<span class="ai-section-title">Phase 1 Focus (Prep / Correctives)</span>');
        tr.phase_1_focus.forEach(x => {
          lines.push('<div>- ' + escapeHtml(x) + '</div>');
        });
      }

      if (Array.isArray(tr.phase_2_focus) && tr.phase_2_focus.length) {
        lines.push('<span class="ai-section-title">Phase 2 Focus (Integration)</span>');
        tr.phase_2_focus.forEach(x => {
          lines.push('<div>- ' + escapeHtml(x) + '</div>');
        });
      }

      // Specific interventions (brief)
      if (Array.isArray(tr.specific_interventions) && tr.specific_interventions.length) {
        lines.push('<span class="ai-section-title">Key Intervention Themes</span>');
        tr.specific_interventions.forEach(si => {
          if (!si.goal) return;
          lines.push('<div><strong>' + escapeHtml(si.goal) + '</strong></div>');
          (si.strategies || []).slice(0, 3).forEach(s => {
            lines.push('<div>- ' + escapeHtml(s) + '</div>');
          });
        });
      }

      // Refer-out flags
      if (Array.isArray(tr.refer_out_flags) && tr.refer_out_flags.length) {
        lines.push('<span class="ai-section-title">Refer-Out Flags</span>');
        tr.refer_out_flags.forEach(r => {
          lines.push('<div class="summary-pill-danger">- ' + escapeHtml(r) + '</div>');
        });
      }

      // Client-facing summary block
      if (client_summary) {
        lines.push('<div class="ai-client-summary"><strong>Client Summary:</strong> ' +
          escapeHtml(client_summary) + '</div>');
      }

      return lines.join('');
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function handleGeneratePdf() {
      const report = buildFmsReport();
      const docDefinition = buildPdfDefinition(report, latestAiInterpretation);
      const filename = (report.client.name || 'client') + '_FMS_Report.pdf';
      pdfMake.createPdf(docDefinition).download(filename);
    }

    function buildPdfDefinition(report, ai) {
      const { client, tests, derived } = report;
      const tableBody = [
        [
          { text: 'Test', bold: true },
          { text: 'Left', bold: true },
          { text: 'Right', bold: true },
          { text: 'Final', bold: true },
          { text: 'Notes / Deviations', bold: true }
        ],
        [
          'Deep Squat',
          '-',
          '-',
          tests.deepSquat.score ?? '',
          (tests.deepSquat.deviations || []).join(', ')
        ],
        [
          'Hurdle Step',
          tests.hurdleStep.left.score ?? '',
          tests.hurdleStep.right.score ?? '',
          tests.hurdleStep.finalScore ?? '',
          (tests.hurdleStep.deviations || []).join(', ')
        ],
        [
          'In-Line Lunge',
          tests.inlineLunge.left.score ?? '',
          tests.inlineLunge.right.score ?? '',
          tests.inlineLunge.finalScore ?? '',
          (tests.inlineLunge.deviations || []).join(', ')
        ],
        [
          'Shoulder Mobility',
          tests.shoulderMobility.left.score ?? '',
          tests.shoulderMobility.right.score ?? '',
          tests.shoulderMobility.finalScore ?? '',
          (tests.shoulderMobility.deviations || []).join(', ')
        ],
        [
          'Active SLR',
          tests.activeSLR.left.score ?? '',
          tests.activeSLR.right.score ?? '',
          tests.activeSLR.finalScore ?? '',
          (tests.activeSLR.deviations || []).join(', ')
        ],
        [
          'Trunk Stability PU',
          '-',
          '-',
          tests.trunkStabilityPU.score ?? '',
          (tests.trunkStabilityPU.deviations || []).join(', ')
        ],
        [
          'Rotary Stability',
          tests.rotaryStability.left.score ?? '',
          tests.rotaryStability.right.score ?? '',
          tests.rotaryStability.finalScore ?? '',
          (tests.rotaryStability.deviations || []).join(', ')
        ]
      ];

      const aiHtml = ai ? formatAiTextForDisplay(ai) : 'AI summary not generated.';
      const aiTextPlain = aiHtml.replace(/<[^>]+>/g, '');

      return {
        content: [
          {
            text: 'Functional Movement Screen Report',
            style: 'header'
          },
          {
            text: `Client: ${client.name || 'N/A'} | Sex: ${client.sex || 'N/A'} | Sport/Occupation: ${client.sport || 'N/A'} | Date: ${client.assessmentDate || 'N/A'}`,
            style: 'subheader'
          },
          {
            text: client.history ? `History/Precautions: ${client.history}` : '',
            margin: [0, 4, 0, 8],
            fontSize: 8
          },
          {
            table: {
              headerRows: 1,
              widths: ['*', 'auto', 'auto', 'auto', '*'],
              body: tableBody
            },
            fontSize: 8,
            margin: [0, 4, 0, 8]
          },
          {
            text: `Total FMS Score: ${derived.totalScore || 'N/A'} / 21`,
            fontSize: 9,
            bold: true,
            margin: [0, 2, 0, 0]
          },
          {
            text: `Pain Present: ${derived.painPresent ? 'Yes (review / consider referral)' : 'No reported'}`,
            fontSize: 8
          },
          {
            text: `Flags: ${derived.flags && derived.flags.length ? derived.flags.join(' | ') : 'None'}`,
            fontSize: 8,
            margin: [0, 0, 0, 6]
          },
          {
            text: 'AI-Assisted Summary (Trainer-Facing)',
            style: 'sectionHeader'
          },
          {
            text: aiTextPlain,
            fontSize: 7,
            margin: [0, 2, 0, 6]
          },
          {
            text: 'This report summarizes functional screening findings and training considerations only. It is not a medical diagnosis. Presence of pain or concerning findings warrants referral to an appropriate licensed provider.',
            fontSize: 6,
            color: '#6b7280'
          }
        ],
        styles: {
          header: {
            fontSize: 13,
            bold: true,
            margin: [0, 0, 0, 3]
          },
          subheader: {
            fontSize: 8,
            margin: [0, 0, 0, 2]
          },
          sectionHeader: {
            fontSize: 8,
            bold: true,
            margin: [0, 4, 0, 2]
          }
        },
        defaultStyle: {
          fontSize: 8
        }
      };
    }
  </script>
</body>
</html>
